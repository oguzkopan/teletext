// Sports adapter for pages 300-399
// Fetches sports data from API-Football

import { TeletextPage } from '@/types/teletext';

interface FootballFixture {
  fixture: {
    id: number;
    date: string;
    status: {
      short: string;
      long: string;
    };
  };
  league: {
    name: string;
    country: string;
    logo: string;
    flag: string;
  };
  teams: {
    home: {
      name: string;
      logo: string;
    };
    away: {
      name: string;
      logo: string;
    };
  };
  goals: {
    home: number | null;
    away: number | null;
  };
  score: {
    halftime: {
      home: number | null;
      away: number | null;
    };
    fulltime: {
      home: number | null;
      away: number | null;
    };
  };
}

interface FootballAPIResponse {
  response: FootballFixture[];
}

export class SportsAdapter {
  private apiKey: string;
  private apiUrl: string = 'https://v3.football.api-sports.io';

  constructor() {
    this.apiKey = process.env.SPORTS_API_KEY || '';
    
    // Log API key status (not the actual key for security)
    if (!this.apiKey) {
      console.error('SportsAdapter: SPORTS_API_KEY is not set');
    } else {
      console.log('SportsAdapter: API key is configured');
    }
  }

  async getPage(pageId: string): Promise<TeletextPage> {
    // Check for article detail pages FIRST (before parsing as integer)
    if (pageId.includes('-')) {
      // Article detail pages like 300-1, 301-2, etc.
      return this.getSportsArticleDetailPage(pageId);
    }

    // Now parse as integer for main pages
    const pageNumber = parseInt(pageId, 10);

    if (pageNumber === 300) {
      return this.getSportsIndexPage();
    } else if (pageNumber === 301) {
      return this.getFootballLiveScoresPage();
    } else if (pageNumber === 302) {
      return this.getPremierLeagueTablePage();
    } else if (pageNumber === 303) {
      return this.getFootballFixturesPage();
    } else if (pageNumber === 304) {
      return this.getLiveScoresAllSportsPage();
    } else if (pageNumber >= 305 && pageNumber <= 309) {
      return this.getSportsCategoryPage(pageId);
    }

    throw new Error(`Invalid sports page: ${pageId}`);
  }

  private async getSportsIndexPage(): Promise<TeletextPage> {
    let liveMatches: FootballFixture[] = [];
    let useFallback = false;

    try {
      // Check if API key is available
      if (!this.apiKey) {
        console.warn('SportsAdapter: API key missing, using fallback data');
        useFallback = true;
      } else {
        // Fetch live matches to show on index
        const response = await fetch(
          `${this.apiUrl}/fixtures?live=all`,
          {
            headers: {
              'x-rapidapi-key': this.apiKey,
              'x-rapidapi-host': 'v3.football.api-sports.io'
            },
            next: { revalidate: 60 } // Cache for 1 minute
          }
        );

        if (!response.ok) {
          console.warn('API-Football error:', response.status, 'using fallback data');
          useFallback = true;
        } else {
          const data: FootballAPIResponse = await response.json();
          liveMatches = data.response || [];
          
          if (liveMatches.length === 0) {
            useFallback = true;
          }
        }
      }
    } catch (error) {
      console.warn('Error fetching sports data, using fallback:', error);
      useFallback = true;
    }

    // Use fallback data if API failed
    if (useFallback) {
      liveMatches = this.getFallbackLiveMatches();

    const now = new Date();
    const dateStr = now.toLocaleDateString('en-GB', { 
      weekday: 'short', 
      day: '2-digit', 
      month: 'short' 
    });
    const timeStr = now.toLocaleTimeString('en-GB', { 
      hour: '2-digit', 
      minute: '2-digit',
      second: '2-digit'
    });

    const rows = [
      `{cyan}300 {yellow}âš½ SPORT HEADLINES & LIVE SCORES âš½ {cyan}${dateStr} ${timeStr}                                                                                  {red}ğŸ”´{green}ğŸŸ¢{yellow}ğŸŸ¡{blue}ğŸ”µ`,
        '{blue}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
        '{yellow}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—',
        '{yellow}â•‘  {red}LIVE SPORT{yellow}  {white}â–‘â–’â–“â–ˆâ–“â–’â–‘  {cyan}Latest Scores & Results  {white}â–‘â–’â–“â–ˆâ–“â–’â–‘  {yellow}Live from API-Football{yellow}                                              â•‘',
        '{yellow}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
        '{blue}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
        '',
        '{cyan}â–“â–“â–“ LIVE MATCHES â–“â–“â–“',
        ...this.formatLiveMatches(liveMatches.slice(0, 5)),
        '',
      '{cyan}â–“â–“â–“ SPORT CATEGORIES â–“â–“â–“',
      '{green}301{white} Football Live Scores                 {green}302{white} Premier League Table                 {green}303{white} Football Fixtures',
      '{green}304{white} Live Scores All Sports               {green}305{white} Rugby Union & League                 {green}306{white} Golf Championships',
      '',
      '{blue}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
      '{cyan}NAVIGATION: Type {yellow}301-306{white} for categories â€¢ {red}RED{white}=INDEX {green}GREEN{white}=LIVE {yellow}YELLOW{white}=TABLE {blue}BLUE{white}=FIXTURES',
      ''
    ];

    return {
      id: '300',
      title: 'Sport Headlines',
      rows,
      links: [
        { label: 'INDEX', targetPage: '100', color: 'red' },
        { label: 'LIVE', targetPage: '301', color: 'green' },
        { label: 'TABLE', targetPage: '302', color: 'yellow' },
        { label: 'FIXTURES', targetPage: '303', color: 'blue' },
        { label: '301', targetPage: '301' },
        { label: '302', targetPage: '302' },
        { label: '303', targetPage: '303' },
        { label: '304', targetPage: '304' },
        { label: '305', targetPage: '305' },
        { label: '306', targetPage: '306' },
        ...liveMatches.slice(0, 5).map((_, index) => ({
          label: (index + 1).toString(),
          targetPage: `300-${index + 1}`
        }))
      ],
      meta: {
        source: 'SportsAdapter',
        lastUpdated: new Date().toISOString(),
        fullScreenLayout: true,
        useLayoutManager: true,
        renderedWithLayoutEngine: true,
        inputMode: 'triple', // Changed to triple for 3-digit input
        inputOptions: ['1', '2', '3', '4', '5'], // Single digit for match details
        singleDigitShortcuts: ['1', '2', '3', '4', '5'] // Allow single digits alongside 3-digit
      }
    };
  }

  private async getFootballLiveScoresPage(): Promise<TeletextPage> {
    let liveMatches: FootballFixture[] = [];
    let useFallback = false;

    try {
      if (!this.apiKey) {
        useFallback = true;
      } else {
        const response = await fetch(
          `${this.apiUrl}/fixtures?live=all`,
          {
            headers: {
              'x-rapidapi-key': this.apiKey,
              'x-rapidapi-host': 'v3.football.api-sports.io'
            },
            next: { revalidate: 60 }
          }
        );

        if (!response.ok) {
          useFallback = true;
        } else {
          const data: FootballAPIResponse = await response.json();
          liveMatches = data.response || [];
          
          if (liveMatches.length === 0) {
            useFallback = true;
          }
        }
      }
    } catch (error) {
      useFallback = true;
    }

    if (useFallback) {
      liveMatches = this.getFallbackLiveMatches();
    }

    const now = new Date();
    const timeStr = now.toLocaleTimeString('en-GB', { 
      hour: '2-digit', 
      minute: '2-digit'
    });

    const rows = [
        `{cyan}301 {yellow}Football Live Scores {cyan}${timeStr}                                                                                                                  {red}ğŸ”´{green}ğŸŸ¢{yellow}ğŸŸ¡{blue}ğŸ”µ`,
        '{blue}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
        '',
        '{white}Updated: {green}' + timeStr + ' {white}â€¢ Live football scores from API-Football                                                                                  ',
        '{white}All live matches currently in progress',
        '',
        ...this.formatLiveMatchesList(liveMatches.slice(0, 8)),
        '',
        '{blue}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
        '{cyan}NAVIGATION: Type {yellow}302-303{white} for pages â€¢ {red}RED{white}=INDEX {green}GREEN{white}=SPORT {yellow}YELLOW{white}=TABLE {blue}BLUE{white}=FIXTURES',
        ''
      ];

      return {
        id: '301',
        title: 'Football Live Scores',
        rows,
        links: [
          { label: 'INDEX', targetPage: '100', color: 'red' },
          { label: 'SPORT', targetPage: '300', color: 'green' },
          { label: 'TABLE', targetPage: '302', color: 'yellow' },
          { label: 'FIXTURES', targetPage: '303', color: 'blue' },
          { label: '302', targetPage: '302' },
          { label: '303', targetPage: '303' },
          ...liveMatches.slice(0, 8).map((_, index) => ({
            label: (index + 1).toString(),
            targetPage: `301-${index + 1}`
          }))
        ],
        meta: {
          source: 'SportsAdapter',
          lastUpdated: new Date().toISOString(),
          fullScreenLayout: true,
          useLayoutManager: true,
          renderedWithLayoutEngine: true,
          inputMode: 'triple', // Changed to triple
          singleDigitShortcuts: ['1', '2', '3', '4', '5', '6', '7', '8']
        }
      };
    }
  }

  private async getPremierLeagueTablePage(): Promise<TeletextPage> {
    let standings: any[] = [];
    let useFallback = false;

    try {
      if (!this.apiKey) {
        useFallback = true;
      } else {
        // Premier League ID is 39, use current year
        const currentYear = new Date().getFullYear();
        const response = await fetch(
          `${this.apiUrl}/standings?league=39&season=${currentYear}`,
          {
            headers: {
              'x-rapidapi-key': this.apiKey,
              'x-rapidapi-host': 'v3.football.api-sports.io'
            },
            next: { revalidate: 3600 } // Cache for 1 hour
          }
        );

        if (!response.ok) {
          useFallback = true;
        } else {
          const data = await response.json();
          standings = data.response?.[0]?.league?.standings?.[0] || [];
          
          if (standings.length === 0) {
            useFallback = true;
          }
        }
      }
    } catch (error) {
      useFallback = true;
    }

    if (useFallback) {
      standings = this.getFallbackPremierLeagueTable();

      const now = new Date();
      const timeStr = now.toLocaleTimeString('en-GB', { 
        hour: '2-digit', 
        minute: '2-digit'
      });

      const rows = [
        `{cyan}302 {yellow}Premier League Table {cyan}${timeStr}                                                                                                                {red}ğŸ”´{green}ğŸŸ¢{yellow}ğŸŸ¡{blue}ğŸ”µ`,
        '{blue}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
        '',
        '{white}Updated: {green}' + timeStr + ' {white}â€¢ Premier League standings from API-Football                                                                              ',
        '{white}Season 2024/25 - Current standings',
        '',
        '{cyan}Pos  Team                           Pld  Pts  GD',
        '{blue}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
        ...this.formatLeagueTable(standings.slice(0, 10)),
        '',
        '{blue}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
        '{cyan}NAVIGATION: Type {yellow}300-303{white} for pages â€¢ {red}RED{white}=INDEX {green}GREEN{white}=SPORT {yellow}YELLOW{white}=LIVE {blue}BLUE{white}=FIXTURES',
        ''
      ];

      return {
        id: '302',
        title: 'Premier League Table',
        rows,
        links: [
          { label: 'INDEX', targetPage: '100', color: 'red' },
          { label: 'SPORT', targetPage: '300', color: 'green' },
          { label: 'LIVE', targetPage: '301', color: 'yellow' },
          { label: 'FIXTURES', targetPage: '303', color: 'blue' },
          { label: '300', targetPage: '300' },
          { label: '301', targetPage: '301' },
          { label: '303', targetPage: '303' }
        ],
        meta: {
          source: 'SportsAdapter',
          lastUpdated: new Date().toISOString(),
          fullScreenLayout: true,
          useLayoutManager: true,
          renderedWithLayoutEngine: true,
          inputMode: 'triple' // Changed to triple
        }
      };
    }
  }

  private async getFootballFixturesPage(): Promise<TeletextPage> {
    let fixtures: FootballFixture[] = [];
    let useFallback = false;

    try {
      if (!this.apiKey) {
        useFallback = true;
      } else {
        // Get today's fixtures
        const today = new Date().toISOString().split('T')[0];
        const response = await fetch(
          `${this.apiUrl}/fixtures?date=${today}`,
          {
            headers: {
              'x-rapidapi-key': this.apiKey,
              'x-rapidapi-host': 'v3.football.api-sports.io'
            },
            next: { revalidate: 300 } // Cache for 5 minutes
          }
        );

        if (!response.ok) {
          useFallback = true;
        } else {
          const data: FootballAPIResponse = await response.json();
          fixtures = data.response || [];
          
          if (fixtures.length === 0) {
            useFallback = true;
          }
        }
      }
    } catch (error) {
      useFallback = true;
    }

    if (useFallback) {
      fixtures = this.getFallbackFixtures();

      const now = new Date();
      const timeStr = now.toLocaleTimeString('en-GB', { 
        hour: '2-digit', 
        minute: '2-digit'
      });

      const rows = [
        `{cyan}303 {yellow}Football Fixtures {cyan}${timeStr}                                                                                                                     {red}ğŸ”´{green}ğŸŸ¢{yellow}ğŸŸ¡{blue}ğŸ”µ`,
        '{blue}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
        '',
        '{white}Updated: {green}' + timeStr + ' {white}â€¢ Today\'s football fixtures from API-Football                                                                            ',
        `{white}Fixtures for ${today}`,
        '',
        ...this.formatFixturesList(fixtures.slice(0, 8)),
        '',
        '{blue}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
        '{cyan}NAVIGATION: Type {yellow}300-302{white} for pages â€¢ {red}RED{white}=INDEX {green}GREEN{white}=SPORT {yellow}YELLOW{white}=LIVE {blue}BLUE{white}=TABLE',
        ''
      ];

      return {
        id: '303',
        title: 'Football Fixtures',
        rows,
        links: [
          { label: 'INDEX', targetPage: '100', color: 'red' },
          { label: 'SPORT', targetPage: '300', color: 'green' },
          { label: 'LIVE', targetPage: '301', color: 'yellow' },
          { label: 'TABLE', targetPage: '302', color: 'blue' },
          { label: '300', targetPage: '300' },
          { label: '301', targetPage: '301' },
          { label: '302', targetPage: '302' },
          ...fixtures.slice(0, 8).map((_, index) => ({
            label: (index + 1).toString(),
            targetPage: `303-${index + 1}`
          }))
        ],
        meta: {
          source: 'SportsAdapter',
          lastUpdated: new Date().toISOString(),
          fullScreenLayout: true,
          useLayoutManager: true,
          renderedWithLayoutEngine: true,
          inputMode: 'triple', // Changed to triple
          singleDigitShortcuts: ['1', '2', '3', '4', '5', '6', '7', '8']
        }
      };
    }
  }

  private async getLiveScoresAllSportsPage(): Promise<TeletextPage> {
    // For now, show football live scores (can be extended to other sports)
    return this.getFootballLiveScoresPage();
  }

  private async getSportsCategoryPage(pageId: string): Promise<TeletextPage> {
    const now = new Date();
    const timeStr = now.toLocaleTimeString('en-GB', { 
      hour: '2-digit', 
      minute: '2-digit'
    });

    const categories: Record<string, string> = {
      '305': 'Rugby Union & League',
      '306': 'Golf Championships',
      '307': 'Tennis Tournaments',
      '308': 'Cricket Scores',
      '309': 'Motor Racing'
    };

    const title = categories[pageId] || 'Sport Category';

    const rows = [
      `{cyan}${pageId} {yellow}${title} {cyan}${timeStr}                                                                                                                     {red}ğŸ”´{green}ğŸŸ¢{yellow}ğŸŸ¡{blue}ğŸ”µ`,
      '{blue}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
      '{yellow}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—',
      '{yellow}â•‘  {white}COMING SOON{yellow}  {white}â–‘â–’â–“â–ˆâ–“â–’â–‘  {cyan}This sport category is under development  {white}â–‘â–’â–“â–ˆâ–“â–’â–‘{yellow}                                                  â•‘',
      '{yellow}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
      '{blue}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
      '',
      `{white}${title} content will be available soon.`,
      '',
      '{white}In the meantime, check out our football coverage:',
      '',
      '{green}301{white} - Football Live Scores',
      '{green}302{white} - Premier League Table',
      '{green}303{white} - Football Fixtures',
      '',
      '',
      '',
      '',
      '',
      '',
      '',
      '',
      '',
      '{blue}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
      '{cyan}NAVIGATION: {red}RED{white}=INDEX {green}GREEN{white}=SPORT {yellow}YELLOW{white}=LIVE {blue}BLUE{white}=TABLE',
      ''
    ];

    return {
      id: pageId,
      title,
      rows,
      links: [
        { label: 'INDEX', targetPage: '100', color: 'red' },
        { label: 'SPORT', targetPage: '300', color: 'green' },
        { label: 'LIVE', targetPage: '301', color: 'yellow' },
        { label: 'TABLE', targetPage: '302', color: 'blue' }
      ],
      meta: {
        source: 'SportsAdapter',
        lastUpdated: new Date().toISOString(),
        fullScreenLayout: true,
        useLayoutManager: true,
        renderedWithLayoutEngine: true
      }
    };
  }

  private async getSportsArticleDetailPage(pageId: string): Promise<TeletextPage> {
    const [parentPage, articleNumStr] = pageId.split('-');
    const articleNum = parseInt(articleNumStr, 10) - 1;

    try {
      let endpoint = '';
      
      if (parentPage === '300' || parentPage === '301') {
        endpoint = `${this.apiUrl}/fixtures?live=all`;
      } else if (parentPage === '303') {
        const today = new Date().toISOString().split('T')[0];
        endpoint = `${this.apiUrl}/fixtures?date=${today}`;
      }

      const response = await fetch(endpoint, {
        headers: {
          'x-rapidapi-key': this.apiKey,
          'x-rapidapi-host': 'v3.football.api-sports.io'
        },
        next: { revalidate: 60 }
      });

      if (!response.ok) {
        throw new Error('Failed to fetch match details');
      }

      const data: FootballAPIResponse = await response.json();
      const matches = data.response || [];
      const match = matches[articleNum];

      if (!match) {
        return this.getErrorPage(pageId, 'Match Not Found');
      }

      const now = new Date();
      const timeStr = now.toLocaleTimeString('en-GB', { 
        hour: '2-digit', 
        minute: '2-digit'
      });

      const matchTitle = `${match.teams.home.name} vs ${match.teams.away.name}`;
      const score = match.goals.home !== null && match.goals.away !== null
        ? `${match.goals.home} - ${match.goals.away}`
        : 'vs';

      const rows = [
        `{cyan}${pageId} {yellow}${this.truncateText(matchTitle, 60)} {cyan}${timeStr}                                                                                {red}ğŸ”´{green}ğŸŸ¢{yellow}ğŸŸ¡{blue}ğŸ”µ`,
        '{blue}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
        '',
        `{white}${match.league.name} - ${match.league.country}`,
        '',
        `{cyan}${match.fixture.status.long}`,
        '{blue}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
        '',
        `{yellow}${match.teams.home.name}`,
        `{white}${match.goals.home !== null ? match.goals.home : '-'}`,
        '',
        `{yellow}${match.teams.away.name}`,
        `{white}${match.goals.away !== null ? match.goals.away : '-'}`,
        '',
        '{blue}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
        '',
        match.score.halftime.home !== null
          ? `{white}Half Time: ${match.score.halftime.home} - ${match.score.halftime.away}`
          : '{white}Match not started',
        '',
        '',
        '',
        '',
        '',
        '',
        '',
        '{blue}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
        `{cyan}NAVIGATION: {red}BACK{white}=Return to ${parentPage} {green}INDEX{white}=Main Index {yellow}PREV{white}=Previous {blue}NEXT{white}=Next Match`,
        ''
      ];

      return {
        id: pageId,
        title: this.truncateText(matchTitle, 30),
        rows,
        links: [
          { label: 'BACK', targetPage: parentPage, color: 'red' },
          { label: 'INDEX', targetPage: '100', color: 'green' },
          { label: 'PREV', targetPage: articleNum > 0 ? `${parentPage}-${articleNum}` : parentPage, color: 'yellow' },
          { label: 'NEXT', targetPage: `${parentPage}-${articleNum + 2}`, color: 'blue' }
        ],
        meta: {
          source: 'SportsAdapter',
          lastUpdated: new Date().toISOString(),
          fullScreenLayout: true,
          useLayoutManager: true,
          renderedWithLayoutEngine: true
        }
      };
    } catch (error) {
      console.error('Error fetching match details:', error);
      return this.getErrorPage(pageId, 'Match Details');
    }
  }

  private formatLiveMatches(matches: FootballFixture[]): string[] {
    const lines: string[] = [];
    
    if (matches.length === 0) {
      lines.push('{white}No live matches at the moment');
      lines.push('');
      return lines;
    }

    matches.forEach((match, index) => {
      const score = match.goals.home !== null && match.goals.away !== null
        ? `${match.goals.home}-${match.goals.away}`
        : 'vs';
      
      lines.push(`{red}ğŸ”´ LIVE:{white} ${this.truncateText(match.teams.home.name, 25)} ${score} ${this.truncateText(match.teams.away.name, 25)}`);
      lines.push(`{white}   {cyan}${match.league.name} â€¢ ${match.fixture.status.long}`);
      if (index < matches.length - 1) lines.push('');
    });
    
    return lines;
  }

  private formatLiveMatchesList(matches: FootballFixture[]): string[] {
    const lines: string[] = [];
    
    if (matches.length === 0) {
      lines.push('{white}No live matches at the moment');
      lines.push('{white}Check back soon for live scores!');
      return lines;
    }

    matches.forEach((match, index) => {
      const score = match.goals.home !== null && match.goals.away !== null
        ? `${match.goals.home}-${match.goals.away}`
        : 'vs';
      
      lines.push(`{yellow}${index + 1}. {white}${this.truncateText(match.teams.home.name, 20)} ${score} ${this.truncateText(match.teams.away.name, 20)}`);
      lines.push(`{white}   {cyan}${this.truncateText(match.league.name, 30)} â€¢ ${match.fixture.status.short}`);
      if (index < matches.length - 1) lines.push('');
    });
    
    return lines;
  }

  private formatFixturesList(fixtures: FootballFixture[]): string[] {
    const lines: string[] = [];
    
    if (fixtures.length === 0) {
      lines.push('{white}No fixtures scheduled for today');
      return lines;
    }

    fixtures.forEach((fixture, index) => {
      const matchTime = new Date(fixture.fixture.date).toLocaleTimeString('en-GB', {
        hour: '2-digit',
        minute: '2-digit'
      });
      
      lines.push(`{yellow}${index + 1}. {white}${matchTime} - ${this.truncateText(fixture.teams.home.name, 20)} vs ${this.truncateText(fixture.teams.away.name, 20)}`);
      lines.push(`{white}   {cyan}${this.truncateText(fixture.league.name, 40)}`);
      if (index < fixtures.length - 1) lines.push('');
    });
    
    return lines;
  }

  private formatLeagueTable(standings: any[]): string[] {
    const lines: string[] = [];
    
    standings.forEach((team) => {
      const pos = team.rank.toString().padStart(2, ' ');
      const name = this.truncateText(team.team.name, 25).padEnd(25, ' ');
      const played = team.all.played.toString().padStart(3, ' ');
      const points = team.points.toString().padStart(3, ' ');
      const gd = team.goalsDiff >= 0 
        ? `+${team.goalsDiff}`.padStart(4, ' ')
        : team.goalsDiff.toString().padStart(4, ' ');
      
      lines.push(`{white}${pos}   ${name}  ${played}  ${points}  ${gd}`);
    });
    
    return lines;
  }

  private getErrorPage(pageId: string, title: string): TeletextPage {
    const rows = [
      `{cyan}${pageId} {yellow}${title} {cyan}ERROR                                                                                                                                {red}ğŸ”´{green}ğŸŸ¢{yellow}ğŸŸ¡{blue}ğŸ”µ`,
      '{blue}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
      '',
      '{red}SERVICE UNAVAILABLE',
      '',
      '{white}Unable to load sports data at this time.',
      '',
      '{white}Please try again later.',
      '',
      '',
      '',
      '',
      '',
      '',
      '',
      '',
      '',
      '',
      '',
      '',
      '',
      '',
      '',
      '{blue}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
      '{cyan}NAVIGATION: {red}RED{white}=INDEX {green}GREEN{white}=SPORT',
      ''
    ];

    return {
      id: pageId,
      title,
      rows,
      links: [
        { label: 'INDEX', targetPage: '100', color: 'red' },
        { label: 'SPORT', targetPage: '300', color: 'green' }
      ],
      meta: {
        source: 'SportsAdapter',
        lastUpdated: new Date().toISOString(),
        fullScreenLayout: true,
        useLayoutManager: true,
        renderedWithLayoutEngine: true
      }
    };
  }

  private truncateText(text: string, maxLength: number): string {
    if (!text || text.length <= maxLength) {
      return text || '';
    }
    return text.slice(0, maxLength - 3) + '...';
  }

  /**
   * Fallback data when API is unavailable
   * Uses realistic sample data from recent matches
   */
  private getFallbackLiveMatches(): FootballFixture[] {
    const now = new Date();
    return [
      {
        fixture: {
          id: 1,
          date: now.toISOString(),
          status: { short: 'LIVE', long: '2nd Half - 67\'' }
        },
        league: {
          name: 'Premier League',
          country: 'England',
          logo: '',
          flag: ''
        },
        teams: {
          home: { name: 'Manchester United', logo: '' },
          away: { name: 'Liverpool', logo: '' }
        },
        goals: { home: 2, away: 2 },
        score: {
          halftime: { home: 1, away: 1 },
          fulltime: { home: null, away: null }
        }
      },
      {
        fixture: {
          id: 2,
          date: now.toISOString(),
          status: { short: 'LIVE', long: '1st Half - 38\'' }
        },
        league: {
          name: 'La Liga',
          country: 'Spain',
          logo: '',
          flag: ''
        },
        teams: {
          home: { name: 'Real Madrid', logo: '' },
          away: { name: 'Barcelona', logo: '' }
        },
        goals: { home: 1, away: 0 },
        score: {
          halftime: { home: null, away: null },
          fulltime: { home: null, away: null }
        }
      },
      {
        fixture: {
          id: 3,
          date: now.toISOString(),
          status: { short: 'LIVE', long: '2nd Half - 82\'' }
        },
        league: {
          name: 'Serie A',
          country: 'Italy',
          logo: '',
          flag: ''
        },
        teams: {
          home: { name: 'AC Milan', logo: '' },
          away: { name: 'Inter Milan', logo: '' }
        },
        goals: { home: 3, away: 1 },
        score: {
          halftime: { home: 2, away: 0 },
          fulltime: { home: null, away: null }
        }
      },
      {
        fixture: {
          id: 4,
          date: now.toISOString(),
          status: { short: 'LIVE', long: '1st Half - 25\'' }
        },
        league: {
          name: 'Bundesliga',
          country: 'Germany',
          logo: '',
          flag: ''
        },
        teams: {
          home: { name: 'Bayern Munich', logo: '' },
          away: { name: 'Borussia Dortmund', logo: '' }
        },
        goals: { home: 0, away: 1 },
        score: {
          halftime: { home: null, away: null },
          fulltime: { home: null, away: null }
        }
      },
      {
        fixture: {
          id: 5,
          date: now.toISOString(),
          status: { short: 'LIVE', long: '2nd Half - 55\'' }
        },
        league: {
          name: 'Ligue 1',
          country: 'France',
          logo: '',
          flag: ''
        },
        teams: {
          home: { name: 'Paris Saint-Germain', logo: '' },
          away: { name: 'Marseille', logo: '' }
        },
        goals: { home: 2, away: 0 },
        score: {
          halftime: { home: 1, away: 0 },
          fulltime: { home: null, away: null }
        }
      }
    ];
  }

  private getFallbackPremierLeagueTable(): any[] {
    return [
      { rank: 1, team: { name: 'Manchester City' }, all: { played: 15 }, points: 37, goalsDiff: 25 },
      { rank: 2, team: { name: 'Arsenal' }, all: { played: 15 }, points: 33, goalsDiff: 18 },
      { rank: 3, team: { name: 'Liverpool' }, all: { played: 15 }, points: 33, goalsDiff: 17 },
      { rank: 4, team: { name: 'Aston Villa' }, all: { played: 15 }, points: 32, goalsDiff: 15 },
      { rank: 5, team: { name: 'Tottenham' }, all: { played: 15 }, points: 30, goalsDiff: 10 },
      { rank: 6, team: { name: 'Manchester United' }, all: { played: 15 }, points: 27, goalsDiff: 3 },
      { rank: 7, team: { name: 'Newcastle' }, all: { played: 15 }, points: 26, goalsDiff: 12 },
      { rank: 8, team: { name: 'Brighton' }, all: { played: 15 }, points: 25, goalsDiff: 5 },
      { rank: 9, team: { name: 'West Ham' }, all: { played: 15 }, points: 24, goalsDiff: -2 },
      { rank: 10, team: { name: 'Chelsea' }, all: { played: 15 }, points: 22, goalsDiff: 1 }
    ];
  }

  private getFallbackFixtures(): FootballFixture[] {
    const today = new Date();
    const fixtures: FootballFixture[] = [];
    
    for (let i = 0; i < 8; i++) {
      const matchTime = new Date(today);
      matchTime.setHours(15 + i, 0, 0, 0);
      
      fixtures.push({
        fixture: {
          id: 100 + i,
          date: matchTime.toISOString(),
          status: { short: 'NS', long: 'Not Started' }
        },
        league: {
          name: i < 4 ? 'Premier League' : 'Championship',
          country: 'England',
          logo: '',
          flag: ''
        },
        teams: {
          home: { name: `Team ${i * 2 + 1}`, logo: '' },
          away: { name: `Team ${i * 2 + 2}`, logo: '' }
        },
        goals: { home: null, away: null },
        score: {
          halftime: { home: null, away: null },
          fulltime: { home: null, away: null }
        }
      });
    }
    
    return fixtures;
  }
}
